[
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Program Enrollment",
  "modified": "2018-10-18 00:16:16.264485",
  "name": "Program Enrollment-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "//cur_frm.cscript.custom_refresh = function(doc) {\n//        cur_frm.doc.student_category = \"Jovenes-Adultos\";\n//\tcur_frm.doc.student_batch_name = \"Ingles\";\n//}\n\n\n"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Student Applicant",
  "modified": "2020-01-01 08:46:03.411436",
  "name": "Student Applicant-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "\nfrappe.ui.form.on('Student Applicant', 'tdx_c_marcartotal', function(frm, cdt, cdn){\nset_calcular(frm);\n})\n//calcular monto total\nvar set_calcular = function(frm){\nvar calcular;\n\tif(frm.doc.tdx_c_ncuotas = 19){\n\t\tcalcular = 7 * (frm.doc.tdx_c_cuota + frm.doc.tdx_c_materiales) + 4 * (frm.doc.tdx_c_cuota + frm.doc.tdx_c_materiales + frm.doc.tdx_c_incremento) + 4 * (frm.doc.tdx_c_cuota + frm.doc.tdx_c_materiales + frm.doc.tdx_c_incremento * 3) + 4 * (frm.doc.tdx_c_cuota + frm.doc.tdx_c_incremento * 4) + frm.doc.tdx_c_materialesie + frm.doc.tdx_c_membresiav;\n\n\t}\nfrm.set_value('tdx_c_total', calcular);\nfrm.refresh();\n}\n\n"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Student Group",
  "modified": "2018-10-31 17:57:40.123920",
  "name": "Student Group-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on('Student Group', 'validate', function(frm){\nset_nombre(frm);\n})\nfrappe.ui.form.on('Student Group Instructor', 'instructor', function(frm, cdt, cdn){\nset_instructor(frm);\n})\n//Instructor\nvar set_instructor = function(frm){\nvar tinstructor=\"\";\n$.each(frm.doc.instructors, function(i, row){\ntinstructor += row.instructor;\n})\nfrm.set_value('tdx_c_intructor', tinstructor);\nfrm.refresh();\n}\n//Nombre \nvar set_nombre = function(frm){\nvar tnombre=\"\";\n\ntnombre = frm.doc.course + \"-\" + frm.doc.tdx_c_aulan + \"-\" + frm.doc.tdx_c_turno + \"-\" + frm.doc.tdx_c_intructor + \"-\" + frm.doc.tdx_c_a\u00f1o + \"-\" + frm.doc.tdx_c_mes + \"-\" + frm.doc.company;\n\nfrm.set_value('student_group_name', tnombre);\nfrm.refresh();\n}\n\n//Buscadores\ncur_frm.add_fetch(\"tdx_c_aula\", \"room_name\", \"tdx_c_aulan\");\n"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Material Request",
  "modified": "2019-03-28 13:14:33.495335",
  "name": "Material Request-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.cscript.custom_refresh = function(doc) {\n    switch(this.frm.doc.company) {\n        case \"VIVENTIAL\":\n            cur_frm.doc.naming_series = \"MREQ-\";\n            break;\n\tcase \"THE ENGLISH WALKER S.A.C.\":\n            cur_frm.doc.naming_series = \"MREQTEW-\";\n            break;\n\tcase \"BLAIBERG CARRASCO\":\n            cur_frm.doc.naming_series = \"MREQBLG-\";\n            break;\n\tcase \"U-EDUCATION E.I.R.L\":\n            cur_frm.doc.naming_series = \"MREQUED-\";\n            break;\n\tcase \"U-EDUCATION IQUITOS\":\n            cur_frm.doc.naming_series = \"MREQUEDIQT-\";\n            break;\n        default:\n            cur_frm.doc.naming_series = \"\";\n            break;\n         }\n}"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Asset Repair",
  "modified": "2019-02-27 19:57:12.208063",
  "name": "Asset Repair-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('codigo','comportamiento','comportamiento');\ncur_frm.add_fetch('codigo','tipo_fluido','tipo_fluido');\n\ncur_frm.add_fetch('producto','item_name','nombre');\ncur_frm.add_fetch('producto','brand','marca');"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Expense Claim",
  "modified": "2019-03-08 11:45:50.830115",
  "name": "Expense Claim-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('tdx_c_codigoproveedor', 'supplier_name', 'tdx_c_proveedor');"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Purchase Order",
  "modified": "2019-06-19 13:06:20.812383",
  "name": "Purchase Order-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Purchase Order\", {\n\tvalidate: function(frm) {\n\t\tvar material_request = 0;\n\t\t$.each(frm.doc.items || [], function(i, d) {\n\t\t\tmaterial_request = d.material_request;\n\t\t});\n\t\tfrm.set_value(\"tdx_c_solicitud\", material_request);\n\t}\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Timesheet",
  "modified": "2019-12-24 16:59:53.080707",
  "name": "Timesheet-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('codigo', 'comportamiento', 'comportamiento');\ncur_frm.add_fetch('codigo', 'tipo_fluido', 'tipo_fluido');\ncur_frm.add_fetch('empleado', 'employee_name', 'nombre_empleado');\ncur_frm.add_fetch('empleado', 'designation', 'puesto');\ncur_frm.add_fetch('task', 'depth', 'tdx_c_prfinitur');\nfunction get_productos(frm, cdt, cdn) {\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"erpnext.projects.doctype.catalogo_proyecto.catalogo_proyecto.get_catalogo_productos\",\n\t\targs: {\n\t\t\tproject: frm.doc.project\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tif (r.message) {\n\t\t\t\tcur_frm.set_query(\"item_code\", \"items\", function(){\n\t\t\t\t\treturn {\n\t\t\t\t\t\t\"filters\": [\n\t\t\t\t\t\t\t[\"Item\", \"name\", \"in\", r.message]]\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t}\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t})\n};\nfunction get_actividades(frm, cdt, cdn) {\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"erpnext.projects.doctype.catalogo_proyecto.catalogo_proyecto.get_catalogo_actividades\",\n\t\targs: {\n\t\t\tproject: frm.doc.project\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tif (r.message) {\n\t\t\t\tcur_frm.set_query(\"activity_type\", \"time_logs\", function(){\n\t\t\t\t\treturn {\n\t\t\t\t\t\t\"filters\": [\n\t\t\t\t\t\t\t[\"Activity Type\", \"name\", \"in\", r.message]]\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tcur_frm.set_query(\"item\", \"perforacion\", function(){\n\t\t\t\t\treturn {\n\t\t\t\t\t\t\"filters\": [\n\t\t\t\t\t\t\t[\"Item\", \"name\", \"in\", r.message]]\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t})\n};\nfunction get_perforado_details(frm, cdt, cdn) {\n\tvar d = locals[cdt][cdn];\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"erpnext.projects.doctype.valoracion_perforado.valoracion_perforado.get_rango_info\",\n\t\targs: {\n\t\t\tproject: frm.doc.project,\n\t\t\trango: d['rango']\n\t\t},\n\t\tcallback: function(r){\n\t\t\td['medida'] = r.message['medida'];\n\t\t\td['precio'] = r.message['precio'];\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t})\n};\nfunction get_actividades_details(frm, cdt, cdn) {\n\tvar d = locals[cdt][cdn];\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"erpnext.projects.doctype.catalogo_proyecto.catalogo_proyecto.get_catalogo_actividades_info\",\n\t\targs: {\n\t\t\tproject: frm.doc.project,\n\t\t\tactividad: d['activity_type']\n\t\t},\n\t\tcallback: function(r){\n\t\t\td['costing_rate'] = r.message['precio'];\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t})\n};\nfunction get_productos_details(frm, cdt, cdn) {\n\tvar d = locals[cdt][cdn];\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"erpnext.projects.doctype.catalogo_proyecto.catalogo_proyecto.get_producto_info\",\n\t\targs: {\n\t\t\tproject: frm.doc.project,\n\t\t\tproducto: d['item_code']\n\t\t},\n\t\tcallback: function(r){\n\t\t\td['item_name'] = r.message['nombre_proyecto'];\n\t\t\td['item_group'] = r.message['grupo'];\n\t\t\td['precio'] = r.message['precio'];\n\t\t\td['stock_uom'] = r.message['stock_uom'];\n\t\t\td['brand'] = r.message['brand'];\n\t\t\td['serial_no'] = r.message['serial_no'];\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t})\n};\nfunction get_metros_perforado(frm, cdt, cdn) {\n\tif (frm.doc.tdx_c_prfinitur !== undefined && frm.doc.tdx_c_prffintur){\n\t\tif (frm.doc.tdx_c_prfinitur < frm.doc.tdx_c_prffintur){\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tdx_c_prfmt\", frm.doc.tdx_c_prffintur - frm.doc.tdx_c_prfinitur)\n\t\t}\n\t}\n};\nfunction get_metros_perforado_detalle(frm, cdt, cdn) {\n\tvar d = locals[cdt][cdn];\n\tif (d['metro_desde'] < d['metro_hasta']){\n\t\td['perforado'] = d['metro_hasta'] - d['metro_desde'];\n\t\tfrm.refresh_fields();\n\t}\n}\nfrappe.ui.form.on(\"Timesheet\", {\n\ttdx_c_prfinitur: function(frm, cdt, cdn) {\n\t\tget_metros_perforado(frm, cdt, cdn);\n\t}\n});\nfrappe.ui.form.on(\"Timesheet\", {\n\ttdx_c_prffintur: function(frm, cdt, cdn) {\n\t\tget_metros_perforado(frm, cdt, cdn);\n\t}\n});\nfrappe.ui.form.on(\"Detalle Perforado\", {\n\t\"metro_desde\": function(frm, cdt, cdn) {\n\t\tget_metros_perforado_detalle(frm, cdt, cdn);\n\t},\n\t\"metro_hasta\": function(frm, cdt, cdn) {\n\t\tget_metros_perforado_detalle(frm, cdt, cdn);\n\t},\n\t\"recuperacion\": function(frm, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\tif (d['recuperacion'] >= 0 && d['perforado'] >= 0){\n\t\t\td['porcentaje_recuperacion'] = d['recuperacion'] / d['perforado'] * 100;\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Timesheet\", {\n\tonload: function(frm, cdt, cdn) {\n\t\tfrm.toggle_display(\"billing_details_amounts\", true);\n\t\tif (frm.doc.total_productos_proyecto === undefined){\n\t\t\tfrappe.model.set_value(cdt, cdn, \"total_productos_proyecto\", 0);\n\t\t\tcur_frm.set_df_property(\"total_productos_proyecto\", \"read_only\", true);\n\t\t}\n\t\tif (frm.doc.total_perforado_valorizado === undefined){\n\t\t\tfrappe.model.set_value(cdt, cdn, \"total_perforado_valorizado\", 0);\n\t\t\tcur_frm.set_df_property(\"total_perforado_valorizado\", \"read_only\", true);\n\t\t}\n\t\tif (frm.doc.tiempo_finalizacion === undefined){\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tiempo_finalizacion\", 0);\n\t\t}\n\t},\n\tproject: function(frm, cdt, cdn) {\n\t\tif (frm.doc.project){\n\t\t\tget_perforado(frm, cdt, cdn);\n\t\t\tget_productos(frm, cdt, cdn);\n\t\t\tget_actividades(frm, cdt, cdn);\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Detalle Perforado Valorizado\", {\n\t\"rango\": function(frm, cdt, cdn) {\n\t\tif (locals[cdt][cdn]['rango']){\n\t\t\tget_perforado_details(frm, cdt, cdn);\n\t\t}\t\t\n\t},\n\t\"metrado\": function(frm, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\tif (d['metrado'] && d['rango']){\n\t\t\td['total'] = d['precio'] * d['metrado'];\n\t\t\tfrm.refresh_fields();\n\t\t\tif (d['total']){\n\t\t\t\tfrappe.model.set_value(d['parenttype'], d['parent'], \"total_perforado_valorizado\", (locals['Timesheet'][d['parent']]['total_perforado_valorizado'] + d['total']))\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif (d['total']){\n\t\t\t\tfrappe.model.set_value(d['parenttype'], d['parent'], \"total_perforado_valorizado\", (locals['Timesheet'][d['parent']]['total_perforado_valorizado'] - d['total']))\n\t\t\t}\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Detalle Productos\", {\n\t\"item_code\": function(frm, cdt, cdn) {\n\t\tif (locals[cdt][cdn]['item_code']){\n\t\t\tget_productos_details(frm, cdt, cdn);\n\t\t}\t\t\n\t},\n\t\"bill\": function(frm, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\tif (d['bill']){\n\t\t\td['qty_bill'] = d['qty'];\n\t\t\td['precio_total'] = d['precio'] * d['qty'];\n\t\t\tfrm.refresh_fields();\n\t\t\tif (d['precio_total']){\n\t\t\t\tfrappe.model.set_value(d['parenttype'], d['parent'], \"total_productos_proyecto\", (locals['Timesheet'][d['parent']]['total_productos_proyecto'] + d['precio_total']));\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif (d['precio_total']){\n\t\t\t\tfrappe.model.set_value(d['parenttype'], d['parent'], \"total_productos_proyecto\", (locals['Timesheet'][d['parent']]['total_productos_proyecto'] - d['precio_total']));\n\t\t\t}\n\t\t}\n\t},\n\t\"qty\": function(frm, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\td['qty_bill'] = d['qty'];\n\t\tfrm.refresh_fields();\n\t}\n});\nfrappe.ui.form.on(\"Timesheet Detail\", {\n\t\"activity_type\": function(frm, cdt, cdn) {\n\t\tif (locals[cdt][cdn]['activity_type']){\n\t\t\tget_actividades_details(frm, cdt, cdn);\n\t\t}\t\t\n\t}\n});\nfrappe.ui.form.on(\"Timesheet Detail\", {\n\t\"activity_type\": function(frm, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\tvar tiempo_finalizacion = locals['Timesheet'][d['parent']]['tiempo_finalizacion'];\n\t\tif (tiempo_finalizacion != 0) {\n\t\t\td['from_time'] = tiempo_finalizacion;\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t},\n\t\"to_time\": function(frm, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\tvar tiempo_finalizacion = locals['Timesheet'][d['parent']]['tiempo_finalizacion'];\n\t\tlocals['Timesheet'][d['parent']]['tiempo_finalizacion'] = d['to_time'];\n\t\tfrm.refresh_fields();\n\t},\n\t\"hours\": function(frm, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\td['billing_hours'] = d['hours'];\n\t\tfrm.refresh_fields();\n\t}\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Task",
  "modified": "2018-12-21 00:37:06.830436",
  "name": "Task-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": ""
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Asset Maintenance Log",
  "modified": "2018-12-21 05:44:20.151144",
  "name": "Asset Maintenance Log-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('tdx_c_codigo','tdx_c_comportamiento','tdx_c_comportamiento');\ncur_frm.add_fetch('tdx_c_codigo','tdx_c_tipofluido','tdx_c_tipofluido');\n\ncur_frm.add_fetch('tdx_c_codigorp','item_name','tdx_c_nombre');\ncur_frm.add_fetch('tdx_c_codigorp','brand','tdx_c_marca');"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Purchase Receipt",
  "modified": "2018-12-02 21:31:30.538195",
  "name": "Purchase Receipt-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('tipo_comprobante', 'codigo_tipo_comprobante', 'codigo_tipo_comprobante');\ncur_frm.add_fetch('tipo_operacion', 'codigo_tipos_operacion', 'codigo_tipo_operacion');\nfunction filter_operacion(frm, cdt, cdn){\n\tcur_frm.set_query(\"tipo_operacion\", function(){\n\t\treturn {\n\t\t\t\"filters\": [\n\t\t\t\t[\"Tipos de Operaciones\", \"codigo_tipos_operacion\", \"in\", [\"02\", \"04\", \"06\"]]]\n\t\t};\n\t});\n}\nfunction filter_comprobantes(frm, cdt, cdn){\n\tcur_frm.set_query(\"tipo_comprobante\", function(){\n\t\treturn {\n\t\t\t\"filters\": [\n\t\t\t\t[\"Tipos de Comprobante\", \"codigo_tipo_comprobante\", \"in\", [\"31\"]]]\n\t\t};\n\t});\n}\nfrappe.ui.form.on(\"Purchase Receipt\", {\n\tonload: function(frm, cdt, cdn){\n\t\tfilter_operacion(frm, cdt, cdn);\n\t\tfilter_comprobantes(frm, cdt, cdn);\n\t}\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Supplier",
  "modified": "2018-12-24 15:44:07.536995",
  "name": "Supplier-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('nombre_tipo_documento', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('nombre_tipo_transporte', 'codigo_tipo_transporte', 'codigo_tipo_transporte');"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Company",
  "modified": "2018-11-27 17:02:53.846817",
  "name": "Company-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('tipo_documento_identidad', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('catalogo_existencias', 'codigo_catalogo', 'codigo_catalogo_existencias');"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Purchase Invoice",
  "modified": "2020-01-24 12:46:03.787100",
  "name": "Purchase Invoice-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('tipo_comprobante', 'codigo_tipo_comprobante', 'codigo_comprobante');\ncur_frm.add_fetch('supplier', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('supplier', 'nombre_tipo_documento', 'tipo_documento_identidad');"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Sales Invoice",
  "modified": "2020-08-03 19:17:31.669390",
  "name": "Sales Invoice-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('customer', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('customer', 'tipo_documento_identidad', 'tipo_documento_identidad');\ncur_frm.add_fetch('tipo_transaccion_sunat', 'codigo_tipo_transaccion', 'codigo_transaccion_sunat');\ncur_frm.add_fetch('tipo_nota_credito', 'codigo_notas_credito', 'codigo_nota_credito');\ncur_frm.add_fetch('tipo_nota_debito', 'codigo_notas_debito', 'codigo_nota_debito');\n\nfunction get_document_series(frm, cdt, cdn) {\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"nubefact_integration.nubefact_integration.doctype.configuracion_nubefact.configuracion_nubefact.get_doc_serie\",\n\t\targs: {\n            company: frm.doc.company,\n\t\t\tdoctype: frm.doc.doctype,\n\t\t\tis_return: frm.doc.is_return ? \"1\" : \"0\",\n\t\t\tes_nota_debito: frm.doc.es_nota_debito ? \"1\" : \"0\",\n\t\t\tcontingencia: frm.doc.contingencia ? \"1\" : \"0\",\n\t\t\tcodigo_tipo_documento: frm.doc.codigo_tipo_documento\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_comprobante\", r.message.descripcion);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_comprobante\", r.message.codigo);\n\t\t\tfrm.set_df_property(\"naming_series\", \"options\", r.message.series);\n\t\t}\n\t});\n}\nfunction get_document_transaction(frm, cdt, cdn) {\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"nubefact_integration.nubefact_integration.doctype.tipos_de_transaccion_sunat.tipos_de_transaccion_sunat.get_tipo_transaccion\",\n\t\targs: {\n\t\t\tcustomer: frm.doc.customer,\n\t\t\tis_return: frm.doc.is_return ? \"1\" : \"0\"\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_transaccion_sunat\", r.message.descripcion);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_transaccion_sunat\", r.message.codigo);\n\t\t}\n\t});\n}\nfunction get_product_anticipo(frm, cdt, cdn) {\n\tif (frm.doc.codigo_transaccion_sunat == \"4\") {\n\t\tfrappe.call({\n\t\t\ttype: \"GET\",\n            method: \"nubefact_integration.nubefact_integration.doctype.configuracion_nubefact.configuracion_nubefact.get_product_anticipo\",\n            args: {\n                company: frm.doc.company\n            },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (r.message) {\n\t\t\t\t\tif (frm.doc.sales_invoice_advance === undefined){\n\t\t\t\t\t\tcur_frm.set_query(\"item_code\", \"items\", function(){\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\"filters\": [\n\t\t\t\t\t\t\t\t\t[\"Item\", \"name\", \"in\", r.message]]\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcur_frm.set_query(\"item_code\", \"items\", function(){\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\"filters\": [\n\t\t\t\t\t\t\t\t\t[\"Item\", \"name\", \"!=\", r.message]]\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tcur_frm.clear_table(\"items\");\n\t\t\t\t\tfrm.refresh_field(\"items\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\telse {\n\t\tfrappe.model.set_value(cdt, cdn, \"sales_invoice_advance\", \"\");\n\t\tcur_frm.toggle_display(\"sales_invoice_advance\", false);\n\t}\n}\nfunction get_sales_invoice_advance(frm, cdt, cdn) {\n\tif (frm.doc.codigo_transaccion_sunat == \"4\") {\n\t\tcur_frm.set_query(\"sales_invoice_advance\" , function(){\n\t\t\treturn {\n\t\t\t\t\"filters\": [\n\t\t\t\t[\"Sales Invoice\", \"codigo_transaccion_sunat\", \"=\", \"4\"],\n\t\t\t\t[\"Sales Invoice\", \"customer\", \"=\", frm.doc.customer],\n\t\t\t\t[\"Sales Invoice\", \"sales_invoice_advance\", \"=\", null]]\n\t\t\t};\n\t\t});\n\t}\n\telse {\n\t\tfrappe.model.set_value(cdt, cdn, \"sales_invoice_advance\", \"\");\n\t}\n}\nfunction get_document_customer(frm, cdt, cdn){\n\treturn new Promise(function(resolve, reject) {\n\t\tif (frm.doc.customer){\n\t\t\tvar values = frappe.db.get_doc(\"Customer\", frm.doc.customer);\n\t\t\tresolve(values);\n\t\t}\n\t}).then(function(values) {\n\t\tfrappe.model.set_value(cdt, cdn, \"codigo_tipo_documento\", values.codigo_tipo_documento);\n\t\tfrappe.model.set_value(cdt, cdn, \"tipo_documento_identidad\", values.tipo_documento_identidad);\n\t\tfrm.refresh_fields();\n\t\tget_document_series(frm, cdt, cdn);\n\t\tget_document_transaction(frm, cdt, cdn);\n\t});\n}\nfrappe.ui.form.on(\"Sales Invoice\", {\n\ttipo_transaccion_sunat: function(frm, cdt, cdn){\n\t\tget_product_anticipo(frm, cdt, cdn);\n\t\tget_sales_invoice_advance(frm, cdt, cdn);\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tsales_invoice_advance: function(frm, cdt, cdn){\n\t\tget_product_anticipo(frm, cdt, cdn);\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tcustomer: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento) {\n\t\t\tget_document_series(frm, cdt, cdn);\n            get_document_transaction(frm, cdt, cdn);\n            set_pos_profile(frm, cdt, cdn);\n\t\t} else {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_comprobante\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_comprobante\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_transaccion_sunat\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_transaccion_sunat\", null);\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tnaming_series: function(frm, cdt, cdn) {\n\t\tset_pos_profile(frm, cdt, cdn);\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tcontingencia: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento && frm.doc.contingencia == 1) {\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tis_return: function(frm, cdt, cdn) {\n\t\tif (frm.doc.is_return == 1){\n\t\t\tfrm.doc.es_nota_debito = 0;\n\t\t\tfrm.doc.tipo_nota_debito = \"\";\n\t\t\tfrm.doc.codigo_nota_debito = \"\";\n\t\t\tfrm.refresh_fields();\n\t\t} else {\n\t\t\tfrm.doc.tipo_nota_credito = \"\";\n\t\t\tfrm.doc.codigo_nota_credito = \"\";\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t\tif (frm.doc.codigo_tipo_documento && frm.doc.is_return == 1) {\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tes_nota_debito: function(frm, cdt, cdn) {\n\t\tif (frm.doc.es_nota_debito == 1){\n\t\t\tfrm.doc.is_return = 0;\n\t\t\tfrm.doc.tipo_nota_credito = \"\";\n\t\t\tfrm.doc.codigo_nota_credito = \"\";\n\t\t\tfrm.refresh_fields();\n\t\t} else {\n\t\t\tfrm.doc.tipo_nota_debito = \"\";\n\t\t\tfrm.doc.codigo_nota_debito = \"\";\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t\tif (frm.doc.codigo_tipo_documento && frm.doc.es_nota_debito == 1) {\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t}\n});\nfrappe.ui.form.on('Sales Invoice', {\n\tbefore_submit: function(frm, cdt, cdn) {\n\t\tif(!frm.doc.customer_address && frm.doc.codigo_tipo_documento != \"-\"){\n            frappe.validated = false;\n            frappe.throw(\"Customer Address is missing\");\n        }\n\t\treturn new Promise(function(resolve, reject) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"nubefact_integration.nubefact_integration.facturacion_electronica.consult_document\",\n\t\t\t\targs: {\n\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t'invoice': frm.doc.name,\n\t\t\t\t\t'doctype': frm.doc.doctype\n\t\t\t\t},\n\t\t\t\tcallback: function(values) {\n\t\t\t\t\tresolve(values);\n\t\t\t\t}\n\t\t\t});\n\t\t}).then(function(values) {\n\t\t\tif (values.message.codigo == \"24\"){\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"nubefact_integration.nubefact_integration.facturacion_electronica.send_document\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t\t'invoice': frm.doc.name,\n\t\t\t\t\t\t'doctype': frm.doc.doctype\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(data) {\n\t\t\t\t\t\tconsole.log(data);\n\t\t\t\t\t\tif (data.message.codigo_hash) {\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"estado_sunat\", (data.message.codigo_hash != \"\") ? (\"Aceptado\") : (\"Rechazado\"));\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"respuesta_sunat\", data.message.sunat_descripcion);\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_qr_sunat\", data.message.cadena_para_codigo_qr);\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_barras_sunat\", data.message.codigo_de_barras);\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_hash_sunat\", data.message.codigo_hash);\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"enlace_pdf\", data.message.enlace_del_pdf);\n\t\t\t\t\t\t\twindow.open(data.message.enlace_del_pdf);\n\t\t\t\t\t\t} else{\n\t\t\t\t\t\t\tfrappe.validated = false;\n\t\t\t\t\t\t\tfrappe.throw(data.message.errors);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"estado_sunat\", (values.message.codigo_hash != \"\") ? (\"Aceptado\") : (\"Rechazado\"));\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"respuesta_sunat\", values.message.sunat_descripcion);\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_qr_sunat\", values.message.cadena_para_codigo_qr);\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_barras_sunat\", values.message.codigo_de_barras);\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_hash_sunat\", values.message.codigo_hash);\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"enlace_pdf\", values.message.enlace_del_pdf);\n\t\t\t\twindow.open(values.message.enlace_del_pdf);\n\t\t\t}\n\t\t});\n\t}\n});\nfrappe.ui.form.on('Sales Invoice', {\n\trefresh: function(frm, cdt, cdn) {\n\t\tif (frm.doc.is_return == 1) {\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t\tif (frm.doc.__islocal == 1){\n\t\t\tif (frm.doc.customer){\n\t\t\t\tget_document_customer(frm, cdt, cdn);\n\t\t\t}\t\t\t\n\t\t}\n\t\tif (frm.doc.__islocal == 1){\n\t\t\tfrappe.model.set_value(cdt, cdn, \"estado_sunat\", \"\");\n\t\t\tfrappe.model.set_value(cdt, cdn, \"respuesta_sunat\", \"\");\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tbefore_cancel: function(frm, cdt, cdn) {\n\t\treturn new Promise(function(resolve, reject) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"nubefact_integration.nubefact_integration.facturacion_electronica.consult_document\",\n\t\t\t\targs: {\n\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t'invoice': frm.doc.name,\n\t\t\t\t\t'doctype': frm.doc.doctype\n\t\t\t\t},\n\t\t\t\tcallback: function(values) {\n\t\t\t\t\tresolve(values);\n\t\t\t\t}\n\t\t\t});\n\t\t}).then(function(values) {\n\t\t\tconsole.log(values);\n\t\t\tif (values.message.codigo != \"24\" && values.message != \"\"){\n\t\t\t\tif (frappe.datetime.get_day_diff(frm.doc.posting_date, frappe.datetime.get_today()) < 7 && frm.doc.estado_anulacion != \"En proceso\") {\n\t\t\t\t\treturn new Promise(function(resolve, reject) {\n\t\t\t\t\t\tfrappe.prompt([\n\t\t\t\t\t\t\t\t{ 'fieldname': 'motivo', 'fieldtype': 'Data', 'label': 'Motivo de la cancelacion', 'reqd': 1 }\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tfunction(values) {\n\t\t\t\t\t\t\t\tresolve(values);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t'Cancelacion de Comprobante',\n\t\t\t\t\t\t\t'Anular'\n\t\t\t\t\t\t);\n\t\t\t\t\t}).then(function(values) {\n\t\t\t\t\t\tfrappe.validated = false;\n\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\tmethod: \"nubefact_integration.nubefact_integration.facturacion_electronica.cancel_document\",\n\t\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t\t\t\t'invoice': frm.docname,\n\t\t\t\t\t\t\t\t'doctype': frm.doctype,\n\t\t\t\t\t\t\t\t'motivo': values.motivo\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tcallback: function(data) {\n\t\t\t\t\t\t\t\tfrappe.msgprint(\"<b>Esperando respuesta de SUNAT</b>\", 'Cancelaci\u00f3n');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tfrappe.validated = false;\n\t\t\t\t\tfrappe.msgprint(\"<b>Documento no se puede anular o esta en proceso de anulaci\u00f3n</b>\", 'Cancelaci\u00f3n');\n\t\t\t\t}\n\t\t\t} \n\t\t});\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tonload: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_qr_sunat === undefined && frm.doc.estado_sunat == \"Aceptado\") {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"estado_sunat\", null);\n\t\t}\n\t}\n});\nfunction set_pos_profile(frm, cdt, cdn) {\n\tif (frm.doc.__islocal == 1 && frm.doc.naming_series != \"\" && frm.doc.customer != \"\"){\n\t\tfrappe.db.get_list(\"POS Profile\", {filters: {selling_price_list: frm.doc.selling_price_list, naming_series: frm.doc.naming_series}}).then(pos_profiles => {\n\t\t\t$.each(pos_profiles, function(i, row){\n\t\t\t\tfrappe.db.get_doc(\"POS Profile\", row.name).then(pos_profile => {\n\t\t\t\t\t$.each(pos_profile.applicable_for_users, function(i, row){\n\t\t\t\t\t\tif (row.user == frappe.session.user){\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"is_pos\", 1);\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"pos_profile\", pos_profile.name);\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"set_warehouse\", pos_profile.warehouse);\n\t\t\t\t\t\t\tfrm.refresh_fields();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n}\n"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Fees",
  "modified": "2020-02-18 08:07:23.152458",
  "name": "Fees-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('student', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('student', 'tipo_documento_identidad', 'tipo_documento_identidad');\ncur_frm.add_fetch('student', 'tax_id', 'tax_id');\ncur_frm.add_fetch('razon_social', 'tax_id', 'tax_id');\ncur_frm.add_fetch('razon_social', 'customer_primary_address', 'direccion');\ncur_frm.add_fetch('tipo_transaccion_sunat', 'codigo_tipo_transaccion', 'codigo_transaccion_sunat');\ncur_frm.add_fetch('tipo_nota_credito', 'codigo_notas_credito', 'codigo_nota_credito');\nfunction set_company_infomation(frm, cdt, cdn) {\n\tswitch(frm.doc.company) {\n        case \"VIVENTIAL\":\n            frappe.model.set_value(cdt, cdn, \"naming_series\", \"FEEVNT-\");\n\t    \tfrappe.model.set_value(cdt, cdn, \"receivable_account\", \"12121001 - Facturas, Boletas Por Cobrar PEN - VNT\");\n\t    \tfrappe.model.set_value(cdt, cdn, \"income_account\", \"70410001 - Prestacion De Servicios a Terceros - VNT\");\t\n            break;\n\t\tcase \"THE ENGLISH WALKER S.A.C.\":\n\t\t\tfrappe.model.set_value(cdt, cdn, \"naming_series\", \"FEETEW-\");\n\t\t\tfrappe.model.set_value(cdt, cdn, \"receivable_account\", \"12121001 - Facturas, Boletas Por Cobrar PEN - TEW\");\n\t\t\tfrappe.model.set_value(cdt, cdn, \"income_account\", \"70410001 - Prestacion De Servicios a Terceros - TEW\");\n\t\t\tbreak;\n\t\tcase \"U-EDUCATION IQUITOS\":\n\t\t\tfrappe.model.set_value(cdt, cdn, \"naming_series\", \"FEEUEDIQT-\");\n\t\t\tfrappe.model.set_value(cdt, cdn, \"receivable_account\", \"12121001 - Facturas, Boletas Por Cobrar PEN - IQT\");\n\t\t\tfrappe.model.set_value(cdt, cdn, \"income_account\", \"70410001 - Prestacion De Servicios a Terceros - IQT\");\n\t\t\tbreak;\n\t\tcase \"INSTITUTO SUPERIOR TECNOLOGICO ISABEL LA CATOLICA E.I.R.L.\":\n\t\t\tfrappe.model.set_value(cdt, cdn, \"naming_series\", \"FEEISC-\");\n\t\t\tfrappe.model.set_value(cdt, cdn, \"receivable_account\", \"12121001 - Facturas, Boletas Por Cobrar PEN - ISC\");\n\t\t\tfrappe.model.set_value(cdt, cdn, \"income_account\", \"70410001 - Prestacion De Servicios a Terceros - ISC\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tfrappe.model.set_value(cdt, cdn, \"naming_series\", \"\");\n\t\t\tbreak;\n\t}\n}\nfunction get_document_series(frm, cdt, cdn){\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"nubefact_integration.nubefact_integration.doctype.configuracion_nubefact.configuracion_nubefact.get_doc_serie\",\n\t\targs: {\n\t\t\tcompany: frm.doc.company,\n\t\t\tdoctype: frm.doc.doctype,\n\t\t\tis_return: frm.doc.is_return ? \"1\" : \"0\",\n\t\t\tcontingencia: frm.doc.contingencia ? \"1\" : \"0\",\n\t\t\tcodigo_tipo_documento: frm.doc.codigo_tipo_documento\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_comprobante\", r.message.descripcion);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_comprobante\", r.message.codigo);\n\t\t\tif (frm.doc.is_return === 1) {\n\t\t\t\tfrm.set_df_property(\"serie_nota_credito\", \"options\", r.message.series);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tfrm.set_df_property(\"serie_comprobante\", \"options\", r.message.series);\n\t\t\t}\n\t\t}\n\t});\n}\nfunction get_document_transaction(frm, cdt, cdn){\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"nubefact_integration.nubefact_integration.doctype.tipos_de_transaccion_sunat.tipos_de_transaccion_sunat.get_tipo_transaccion_fee\",\n\t\targs: {\n\t\t\tstudent: frm.doc.student,\n\t\t\tis_return: frm.doc.is_return ? \"1\" : \"0\"\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_transaccion_sunat\", r.message.descripcion);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_transaccion_sunat\", r.message.codigo);\n\t\t}\n\t});\n}\n\nfrappe.ui.form.on(\"Fees\", {\n\tstudent: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento){\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t\tget_document_transaction(frm, cdt, cdn);\n\t\t}\n\t\telse {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_comprobante\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_comprobante\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_transaccion_sunat\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_transaccion_sunat\", null);\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Fees\", {\n\tcontingencia: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento){\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Fees\", {\n\tis_return: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento){\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t}\t\n});\nfrappe.ui.form.on(\"Fees\", {\n\tfactura_de_venta: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento){\n\t\t\tif (frm.doc.factura_de_venta == \"1\"){\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_documento_identidad\", \"REGISTRO \u00daNICO DE CONTRIBUYENTES\");\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_tipo_documento\", \"6\");\n\t\t\t\tfrappe.model.set_value(cdt,cdn, \"tax_id\", \"\");\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_documento_identidad\", \"DOCUMENTO NACIONAL DE IDENTIDAD (DNI)\");\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_tipo_documento\", \"1\");\n\t\t\t}\t\t\t\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t}\t\n});\nfrappe.ui.form.on('Fees', {\n\trefresh: function(frm, cdt, cdn){\n\t\tif (frm.doc.is_return == 1){\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t\tif(frm.doc.docstatus === 1 && frm.doc.outstanding_amount == 0 && frm.doc.numero_comprobante == null) {\n\t\t\tfrm.add_custom_button(__(\"Generate Invoice\"), function() {\n\t\t\t\tfrm.events.make_electronic_invoice(frm, cdt, cdn);\n\t\t\t}, __(\"Make\"));\n\t\t\tfrm.page.set_inner_btn_group_as_primary(__(\"Make\"));\n\t\t}\n\t\tif(frm.doc.is_return===1 && frm.doc.tipo_nota_credito != null && frm.doc.serie_nota_credito != null && frm.doc.numero_nota_credito == null) {\n\t\t\tfrm.add_custom_button(__(\"Generate Credit Note\"), function() {\n\t\t\t\tfrm.events.make_electronic_invoice(frm, cdt, cdn);\n\t\t\t}, __(\"Make\"));\n\t\t\tfrm.page.set_inner_btn_group_as_primary(__(\"Make\"));\n\t\t}\n\t\tif(frm.doc.enlace_pdf != null) {\n\t\t\tfrm.add_custom_button(__(\"View Invoice\"), function() {\n\t\t\t\twindow.open(frm.doc.enlace_pdf);\n\t\t\t}, __(\"View\"));\n\t\t\tfrm.page.set_inner_btn_group_as_primary(__(\"View\"));\n\t\t}\n\t\tif (frm.doc.__islocal == 1){\n\t\t\tset_company_infomation(frm, cdt, cdn);\n\t\t}\n\t},\n\n\tmake_electronic_invoice: function(frm, cdt, cdn){\n\t\tvar flag = true;\n\t\tif (frm.doc.factura_de_venta == 1){\n\t\t\tif (typeof frm.doc.razon_social === 'undefined' || typeof frm.doc.tax_id === 'undefined' || typeof frm.doc.direccion === 'undefined'){\n\t\t\t\tflag = false;\n\t\t\t}\n\t\t}\n\t\tif (flag) {\n\t\t\tif (frm.doc.estado_sunat == null || frm.doc.is_return == 1) {\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"nubefact_integration.nubefact_integration.facturacion_electronica.send_document\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t\t'invoice': frm.doc.name,\n\t\t\t\t\t\t'doctype': frm.doc.doctype\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(data) {\n\t\t\t\t\t\tif (frm.doc.is_return === 1) {\n\t\t\t\t\t\t\tfrm.set_value(\"numero_nota_credito\", data.message.numero_nota_credito);\n\t\t\t\t\t\t\tfrm.set_value(\"fecha_nota_credito\", frappe.datetime.nowdate());\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tfrm.set_value(\"numero_comprobante\", data.message.numero_comprobante);\n\t\t\t\t\t\t\tfrm.set_value(\"fecha_comprobante\", frappe.datetime.nowdate());\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (data.message.codigo_hash) {\n\t\t\t\t\t\t\tfrm.set_value(\"estado_sunat\", (data.message.codigo_hash) ? (\"Aceptado\") : (\"Rechazado\"));\n\t\t\t\t\t\t\tfrm.set_value(\"respuesta_sunat\", data.message.sunat_description);\n\t\t\t\t\t\t\tfrm.set_value(\"codigo_qr_sunat\", data.message.cadena_para_codigo_qr);\n\t\t\t\t\t\t\tfrm.set_value(\"codigo_barras_sunat\", data.message.codigo_de_barras);\n\t\t\t\t\t\t\tfrm.set_value(\"enlace_pdf\", data.message.enlace_del_pdf);\n\t\t\t\t\t\t\tfrm.set_value(\"codigo_hash_sunat\", data.message.codigo_hash);\n\t\t\t\t\t\t\tfrm.save_or_update();\n\t\t\t\t\t\t} else{\n\t\t\t\t\t\t\treturn new Promise(function(resolve, reject) {\n\t\t\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\t\t\tmethod: \"nubefact_integration.nubefact_integration.utils.revert_fee_numero_comprobante\",\n\t\t\t\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\t\t\t\t'serie_comprobante': frm.doc.serie_comprobante,\n\t\t\t\t\t\t\t\t\t\t'numero_comprobante': frm.doc.numero_comprobante,\n\t\t\t\t\t\t\t\t\t\t'serie_nota_credito': frm.doc.serie_nota_credito,\n\t\t\t\t\t\t\t\t\t\t'numero_nota_credito': frm.doc.numero_nota_credito,\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}).then(function(values) {\n\t\t\t\t\t\t\t\tfrappe.throw(data.message.errors);\n\t\t\t\t\t\t\t\tif (frm.doc.is_return === 1) {\n\t\t\t\t\t\t\t\t\tfrm.set_value(\"numero_nota_credito\", \"\");\n\t\t\t\t\t\t\t\t\tfrm.set_value(\"fecha_nota_credito\", \"\");\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\tfrm.set_value(\"numero_comprobante\", \"\");\n\t\t\t\t\t\t\t\t\tfrm.set_value(\"fecha_comprobante\", \"\");\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tfrm.save_or_update();\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tsetup: function(frm, cdt, cdn) {\n\t\tfrm.set_query('direccion', function(doc) {\n\t\t\treturn {\n\t\t\t\tquery: \"erpnext.selling.doctype.customer.customer.get_customer_address\",\n\t\t\t\tfilters: {\n\t\t\t\t\t'customer': doc.razon_social\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t}\n});\nfrappe.ui.form.on(\"Fees\", {\n\tbefore_cancel: function(frm, cdt, cdn){\n\t\tif (frappe.datetime.get_day_diff(frm.doc.posting_date, frappe.datetime.get_today()) < 7 && frm.doc.estado_anulacion != \"En proceso\" && frm.doc.numero_nota_credito == null){\n\t\t\treturn new Promise(function(resolve, reject) {\n\t\t\t\tfrappe.prompt([\n\t\t\t\t\t{'fieldname': 'motivo', 'fieldtype': 'Data', 'label': 'Motivo de la cancelacion', 'reqd': 1}  \n\t\t\t\t],\n\t\t\t\tfunction(values){\n\t\t\t\t\tresolve(values);\n\t\t\t\t},\n\t\t\t\t'Cancelacion de Comprobante',\n\t\t\t\t'Anular'\n\t\t\t\t);\n\t\t\t}).then(function (values){\n\t\t\t\tfrappe.validated = false;\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"nubefact_integration.nubefact_integration.facturacion_electronica.cancel_document\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t\t'invoice': frm.docname,\n\t\t\t\t\t\t'doctype': frm.doctype,\n\t\t\t\t\t\t'motivo': values.motivo\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function (data) {\n\t\t\t\t\t\tconsole.log(data);\n\t\t\t\t\t\tfrappe.msgprint(\"<b>Esperando respuesta de SUNAT</b>\", 'Cancelaci\u00f3n');\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\tfrappe.validated = false;\n\t\t\tfrappe.msgprint(\"<b>Documento no se puede anular o esta en proceso de anulaci\u00f3n</b>\", 'Cancelaci\u00f3n');\n\t\t}\n\t}\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Student",
  "modified": "2018-11-22 16:31:36.767551",
  "name": "Student-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('tipo_documento_identidad', 'codigo_tipo_documento', 'codigo_tipo_documento');"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Item",
  "modified": "2018-11-27 11:59:51.952076",
  "name": "Item-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('stock_uom', 'codigo_sunat', 'codigo_uom');\ncur_frm.add_fetch('tipo_existencia', 'codigo_tipos_existencia', 'codigo_tipo_existencia');"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Stock Entry",
  "modified": "2019-05-21 12:49:40.814191",
  "name": "Stock Entry-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "//PERSONALIZACION\ncur_frm.add_fetch(\"tdx_c_solicitadopor\", \"employee_name\", \"tdx_c_solicitadonombre\");\ncur_frm.add_fetch(\"tdx_c_autorizadopor\", \"employee_name\", \"tdx_c_autorizadonombre\");\ncur_frm.add_fetch(\"tdx_c_ut_transportista\", \"tax_id\", \"tdx_c_ut_transportistan\");\ncur_frm.add_fetch(\"tdx_c_ut_placa\", \"make\", \"tdx_c_ut_marca\");\n//FIN PERSONALIZACION\ncur_frm.add_fetch('tipo_operacion', 'codigo_tipos_operacion', 'codigo_tipo_operacion');\nfunction filter_operacion(frm, cdt, cdn){\n\tif (frm.doc.purpose == \"Material Issue\"){\n\t\tcur_frm.set_query(\"tipo_operacion\", function(){\n\t\t\treturn {\n\t\t\t\t\"filters\": [\n\t\t\t\t\t[\"Tipos de Operaciones\", \"codigo_tipos_operacion\", \"in\", [\"12\", \"13\", \"14\", \"15\", \"28\"]]]\n\t\t\t}\n\t\t});\n\t}\n\telse {\n\t\tfrm.toggle_display(\"tipo_operacion\", false);\n\t\tfrm.toggle_display(\"codigo_tipo_operacion\", false);\n\t\tfrm.toggle_display(\"sb_sunat\", false);\n\t\tfrappe.model.set_value(cdt, cdn, \"codigo_tipo_operacion\", \"00\");\n\t}\n}\nfrappe.ui.form.on(\"Stock Entry\", {\n\tonload: function(frm, cdt, cdn){\n\t\tfilter_operacion(frm, cdt, cdn);\n\t}\n});\nfrappe.ui.form.on(\"Stock Entry\", {\n\tpurpose: function(frm, cdt, cdn){\n\t\tfilter_operacion(frm, cdt, cdn);\n\t}\n});\n"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Delivery Note",
  "modified": "2020-01-17 11:44:58.506348",
  "name": "Delivery Note-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('tipo_comprobante', 'codigo_tipo_comprobante', 'codigo_tipo_comprobante');\ncur_frm.add_fetch('customer', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('customer', 'tipo_documento_identidad', 'tipo_documento_identidad');\ncur_frm.add_fetch('motivo_traslado', 'codigo_motivo_traslado', 'codigo_motivo_traslado');\ncur_frm.add_fetch('tipo_transporte', 'codigo_tipo_transporte', 'codigo_tipo_transporte');\ncur_frm.add_fetch('transporter', 'nombre_tipo_transporte', 'tipo_transporte');\ncur_frm.add_fetch('transporter', 'codigo_tipo_transporte', 'codigo_tipo_transporte');\n\nfunction get_document_customer(frm, cdt, cdn){\n\treturn new Promise(function(resolve, reject) {\n\t\tif (frm.doc.customer){\n\t\t\tvar values = frappe.db.get_doc(\"Customer\", frm.doc.customer);\n\t\t\tresolve(values);\n\t\t}\n\t}).then(function(values) {\n\t\tfrappe.model.set_value(cdt, cdn, \"codigo_tipo_documento\", values.codigo_tipo_documento);\n\t\tfrappe.model.set_value(cdt, cdn, \"tipo_documento_identidad\", values.tipo_documento_identidad);\n\t\tfrm.refresh_fields();\n\t\tget_document_series(frm, cdt, cdn);\n\t});\n}\nfunction filter_comprobantes(frm, cdt, cdn){\n\tcur_frm.set_query(\"tipo_comprobante\", function(){\n\t\treturn {\n\t\t\t\"filters\": [\n\t\t\t\t[\"Tipos de Comprobante\", \"codigo_tipo_comprobante\", \"in\", [\"09\"]]]\n\t\t};\n\t});\n}\nfrappe.ui.form.on(\"Delivery Note\", {\n\tonload: function(frm, cdt, cdn){\n\t\tfilter_comprobantes(frm, cdt, cdn);\n\t}\n});\nfunction get_document_series(frm, cdt, cdn){\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"nubefact_integration.nubefact_integration.doctype.configuracion_nubefact.configuracion_nubefact.get_doc_serie\",\n\t\targs: {\n\t\t\tcompany: frm.doc.company,\n\t\t\tdoctype: frm.doc.doctype,\n\t\t\tcodigo_comprobante: frm.doc.codigo_comprobante\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_comprobante\", r.message.descripcion);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_tipo_comprobante\", r.message.codigo);\n\t\t\tfrm.set_df_property(\"naming_series\", \"options\", r.message.series);\n\t\t}\n\t});\n}\nfrappe.ui.form.on(\"Delivery Note\", {\n\tcustomer: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento){\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t\telse {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_comprobante\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_comprobante\", null);\n\t\t}\n\t}\n});\nfrappe.ui.form.on('Delivery Note', {\n\tbefore_submit: function(frm, cdt, cdn) {\n\t\tif(!frm.doc.customer_address || !frm.doc.transporter || ! frm.doc.driver){\n            frappe.validated = false;\n            frappe.throw(\"Data is missing, please check\");\n        }\n        if (frm.doc.estado_sunat == null || frm.doc.is_return == 1) {\n            return new Promise(function(resolve, reject) {\n\t\t\t\tfrappe.call({\n                    method: \"nubefact_integration.nubefact_integration.facturacion_electronica.consult_document\",\n                    args: {\n                        'company': frm.doc.company,\n                        'invoice': frm.doc.name,\n                        'doctype': frm.doc.doctype\n                    },\n                    callback: function(values) {\n                        resolve(values);\n                    }\n                });\n\t\t\t}).then(function(values) {\n                if (values.message.codigo == \"24\"){\n                    frappe.call({\n                        method: \"nubefact_integration.nubefact_integration.facturacion_electronica.send_document\",\n                        args: {\n                            'company': frm.doc.company,\n                            'invoice': frm.doc.name,\n                            'doctype': frm.doc.doctype\n                        },\n                        callback: function(data) {\n                            console.log(data);\n                            if (data.message.aceptada_por_sunat) {\n                                frappe.model.set_value(cdt, cdn, \"estado_sunat\", (data.message.aceptada_por_sunat) ? (\"Aceptado\") : (\"Rechazado\"));\n                                frappe.model.set_value(cdt, cdn, \"respuesta_sunat\", data.message.sunat_description);\n                                frappe.model.set_value(cdt, cdn, \"codigo_qr_sunat\", data.message.cadena_para_codigo_qr);\n                                frappe.model.set_value(cdt, cdn, \"codigo_hash_sunat\", data.message.codigo_hash);\n                            } else{\n                                frappe.validated = false;\n                                frappe.throw(data.message.errors);\n                            }\n                        }\n                    });\n                } else {\n                    frappe.model.set_value(cdt, cdn, \"estado_sunat\", (values.message.aceptada_por_sunat) ? (\"Aceptado\") : (\"Rechazado\"));\n                    frappe.model.set_value(cdt, cdn, \"respuesta_sunat\", values.message.sunat_description);\n                    frappe.model.set_value(cdt, cdn, \"codigo_qr_sunat\", values.message.cadena_para_codigo_qr);\n                    frappe.model.set_value(cdt, cdn, \"codigo_hash_sunat\", values.message.codigo_hash);\n                }\n\t\t\t});\n        }\n\t}\n});\nfrappe.ui.form.on('Delivery Note', {\n\trefresh: function(frm, cdt, cdn) {\n\t\tif (frm.doc.customer){\n\t\t\tget_document_customer(frm, cdt, cdn);\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Delivery Note\", {\n\tbefore_cancel: function(frm, cdt, cdn) {\n\t\treturn new Promise(function(resolve, reject) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"nubefact_integration.nubefact_integration.facturacion_electronica.consult_document\",\n\t\t\t\targs: {\n\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t'invoice': frm.doc.name,\n\t\t\t\t\t'doctype': frm.doc.doctype\n\t\t\t\t},\n\t\t\t\tcallback: function(values) {\n\t\t\t\t\tresolve(values);\n\t\t\t\t}\n\t\t\t});\n\t\t}).then(function(values) {\n\t\t\tif (values.message.codigo != \"24\" && values.message != \"\"){\n\t\t\t\tif (frappe.datetime.get_day_diff(frm.doc.posting_date, frappe.datetime.get_today()) < 7 && frm.doc.estado_anulacion != \"En proceso\") {\n\t\t\t\t\treturn new Promise(function(resolve, reject) {\n\t\t\t\t\t\tfrappe.prompt([\n\t\t\t\t\t\t\t\t{ 'fieldname': 'motivo', 'fieldtype': 'Data', 'label': 'Motivo de la cancelacion', 'reqd': 1 }\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tfunction(values) {\n\t\t\t\t\t\t\t\tresolve(values);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t'Cancelacion de Comprobante',\n\t\t\t\t\t\t\t'Anular'\n\t\t\t\t\t\t);\n\t\t\t\t\t}).then(function(values) {\n\t\t\t\t\t\tfrappe.validated = false;\n\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\tmethod: \"nubefact_integration.nubefact_integration.facturacion_electronica.cancel_document\",\n\t\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t\t\t\t'invoice': frm.docname,\n\t\t\t\t\t\t\t\t'doctype': frm.doctype,\n\t\t\t\t\t\t\t\t'motivo': values.motivo\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tcallback: function(data) {\n\t\t\t\t\t\t\t\tfrappe.msgprint(\"<b>Esperando respuesta de SUNAT</b>\", 'Cancelaci\u00f3n');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tfrappe.validated = false;\n\t\t\t\t\tfrappe.msgprint(\"<b>Documento no se puede anular o esta en proceso de anulaci\u00f3n</b>\", 'Cancelaci\u00f3n');\n\t\t\t\t}\n\t\t\t} \n\t\t});\n\t}\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "UOM",
  "modified": "2018-11-29 14:51:35.174065",
  "name": "UOM-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('unidad_medida_sunat', 'codigo_unidad_medida', 'codigo_sunat');"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Driver",
  "modified": "2018-12-24 10:58:16.139227",
  "name": "Driver-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "cur_frm.add_fetch('tipo_documento_identidad', 'codigo_tipo_documento', 'codigo_documento_identidad');"
 }
]